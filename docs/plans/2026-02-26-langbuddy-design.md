# LangBuddy — Design Document
*2026-02-26*

## Overview

LangBuddy is a personal Korean language learning web app for a 1.5-generation immigrant with conversational Korean but weak vocabulary and reading skills. The core loop: share any article or Reddit link → receive an AI-adapted Korean version at your skill level → quiz yourself on vocabulary inline → complete comprehension questions → track your score.

---

## Architecture

| Layer | Technology |
|---|---|
| Frontend | Next.js (App Router), deployed on Vercel |
| Database | Supabase (Postgres) |
| Auth | NextAuth.js with Google OAuth |
| AI | Claude API (`claude-sonnet-4-6`) via server-side API routes |
| Article extraction | `@mozilla/readability` (server-side) |
| Reddit content | Reddit public JSON API (`{url}.json`) |
| PWA | Web Share Target manifest + service worker |

All Claude API calls are made server-side. The API key is never exposed to the browser.

---

## Entry Point: iOS Share Sheet

The primary way to add articles is via the iOS share sheet while browsing Reddit or any website on iPhone. LangBuddy is installed as a PWA (added to home screen), which registers it as a share target. Tapping Share → LangBuddy passes the URL directly to the app and kicks off article processing — no copy-pasting or manual URL entry.

For Reddit URLs, the app detects this and prompts: **"Adapt the linked article"** or **"Adapt this Reddit discussion"** before processing.

---

## Screens

### 1. Reading List (Home)
- RSS/Reddit-style feed of unread and in-progress articles
- Each card: title, source domain or subreddit, timestamp, one-line excerpt, status badge (unread / in progress)
- Completed articles are archived automatically — not shown in the main feed
- Header includes access to Archive and Word Bank
- Archive: searchable list of all completed articles with their locked scores

### 2. Article Processing
- Shown immediately after a URL is shared or submitted
- Streaming loading state while Claude adapts the article
- Auto-transitions to Reading View when complete

### 3. Reading View
- Adapted Korean article shown by default
- **Double-tap anywhere** to toggle between Korean and English (brief overlay label confirms the switch)
- Single-tap on a highlighted word opens the word quiz popup
- Two highlight types:
  - **Blue underline** — new vocabulary word for this TOPIK level
  - **Orange underline** — word from your active word bank (reinforcement)
- Live word quiz score shown in the header
- **"I'm done reading"** button at the bottom

### 4. Comprehension Screen
- 3 multiple-choice questions, presented one at a time
- One attempt only — no going back
- Generated by Claude at article adaptation time, stored with the article
- Correct answers add points; wrong answers deduct points

### 5. Summary Score Screen
- Word quiz score (running total from all inline quizzes)
- Comprehension score (from the 3 end questions)
- Combined total score
- Article is moved to archive after viewing this screen

### 6. Word Bank
- Full list of saved words sorted by mastery level or date added
- Each entry: Korean word, English definition, mastery bar (0–100)
- Active words (mastery 0–99) and Mastered words (mastery 100) in separate sections
- Tap any word for full details and example sentence

---

## Word Bank Mechanics

**How words enter the bank:**
- Tapping a highlighted new vocabulary word during reading opens a quiz popup
- 4 multiple-choice English definitions (1 correct + 3 Claude-generated distractors)
- Correct answer: word is added to word bank at mastery 1 (or +1 if already present)
- Wrong answer: word is added to word bank at mastery 0 (or -1 if already present, floored at 0)

**Mastery progression:**
- Mastery is an integer 0–100
- Each correct quiz answer: +1
- Each wrong quiz answer: -1 (floor 0)
- At mastery 100: word graduates to "Mastered"

**Mastered word maintenance:**
- Graduated words reappear occasionally as maintenance quizzes
- A wrong answer drops mastery to 99 and re-enters the active cycle

**Integration with future articles:**
- Claude receives a list of your active word bank words (mastery 0–99) and is instructed to naturally incorporate them into adapted text
- These appear as orange-underlined words in the Reading View

---

## Scoring

Each article has a permanent, one-time score:

- **Word quiz score**: sum of all +1/-1 from inline quiz answers during reading
- **Comprehension score**: sum of +1/-1 from the 3 end-of-article questions
- **Total score**: combined

Scores are locked when the article is archived. Re-reading is not allowed — one score per article, permanent. Scores are visible on archived article cards.

---

## Data Model

```sql
-- Auth (managed by NextAuth)
users (id, email, created_at)

-- User preferences
user_settings (user_id, topik_level)  -- topik_level: 1–6

-- Word bank
words (
  id, user_id,
  korean text,
  english text,
  romanization text,
  example_sentence text,
  mastery_level int,      -- 0–100
  times_seen int,
  times_correct int,
  created_at,
  last_seen_at
)

-- Articles
articles (
  id, user_id,
  source_url text,
  title text,
  adapted_korean text,
  original_english text,
  topik_level_at_time int,
  status text,            -- 'unread' | 'reading' | 'completed'
  word_quiz_score int,
  comprehension_score int,
  total_score int,
  comprehension_questions jsonb,  -- [{question, options, correct, user_answer}]
  created_at,
  completed_at
)

-- Which word bank words appeared in each article
article_words (article_id, word_id)
```

---

## Key AI Prompt Design

Claude is called once per article with a structured prompt that returns JSON:

**Input to Claude:**
- TOPIK level (1–6)
- Active word bank words (mastery 0–99)
- Extracted article text

**Output from Claude:**
```json
{
  "adapted_korean": "...",
  "new_vocabulary": [
    { "korean": "...", "english": "...", "romanization": "...", "example": "..." }
  ],
  "comprehension_questions": [
    {
      "question": "...",
      "options": ["A", "B", "C", "D"],
      "correct": "A"
    }
  ]
}
```

Word bank words that appear in the adapted text are identified by matching against the returned Korean text. New vocabulary words are highlighted at render time using the positions/tokens returned by Claude.

---

## PWA / Share Target

`manifest.json` declares a share target:

```json
{
  "share_target": {
    "action": "/share",
    "method": "GET",
    "params": { "url": "url" }
  }
}
```

The `/share` route receives the URL, starts processing, and redirects to the Article Processing screen.

---

## Out of Scope (v1)

- Push notifications
- Social features / sharing scores
- Audio / pronunciation
- Handwriting practice
- Android share sheet (same PWA mechanism, lower priority)
