# LangBuddy — Design Document
*2026-02-26*

## Overview

LangBuddy is a personal Korean language learning web app for a 1.5-generation immigrant with conversational Korean but weak vocabulary and reading skills. The core loop: share any article or Reddit link → receive an AI-adapted Korean version at your skill level → quiz yourself on vocabulary inline → complete comprehension questions → track your score.

---

## Architecture

| Layer | Technology |
|---|---|
| Frontend | Next.js (App Router), deployed on Vercel |
| Database | Supabase (Postgres) |
| Auth | NextAuth.js with Google OAuth |
| AI | Claude API (`claude-sonnet-4-6`) via server-side API routes |
| Article extraction | `@mozilla/readability` (server-side) |
| Reddit content | Reddit public JSON API (`{url}.json`) |
| PWA | Web Share Target manifest + service worker |

All Claude API calls are made server-side. The API key is never exposed to the browser.

---

## Entry Point: iOS Share Sheet

The primary way to add articles is via the iOS share sheet while browsing Reddit or any website on iPhone. LangBuddy is installed as a PWA (added to home screen), which registers it as a share target. Tapping Share → LangBuddy passes the URL directly to the app and kicks off article processing — no copy-pasting or manual URL entry.

For Reddit URLs, the app detects this and prompts: **"Adapt the linked article"** or **"Adapt this Reddit discussion"** before processing.

---

## Screens

### 1. Reading List (Home)
- RSS/Reddit-style feed of unread and in-progress articles
- Each card: title, source domain or subreddit, timestamp, one-line excerpt, status badge (unread / in progress)
- Completed articles are archived automatically — not shown in the main feed
- Header includes access to Archive and Word Bank
- Archive: searchable list of all completed articles with their locked scores

### 2. Article Processing
- Shown immediately after a URL is shared or submitted
- Streaming loading state while Claude adapts the article
- Auto-transitions to Reading View when complete

### 3. Reading View
- Adapted Korean article shown by default
- **Double-tap anywhere** to toggle between Korean and English (brief overlay label confirms the switch)
- Single-tap on a highlighted word opens the word quiz popup
- Two highlight types:
  - **Blue underline** — new vocabulary word for this TOPIK level
  - **Orange underline** — word from your active word bank (reinforcement)
- Live word quiz score shown in the header
- **"I'm done reading"** button at the bottom

### 4. Comprehension Screen
- 3 multiple-choice questions, presented one at a time
- One attempt only — no going back
- Generated by Claude at article adaptation time, stored with the article
- Correct answers add points; wrong answers deduct points

### 5. Summary Score Screen
- Word quiz score (running total from all inline quizzes)
- Comprehension score (from the 3 end questions)
- Combined total score
- Article is moved to archive after viewing this screen

### 6. Word Bank
- Full list of saved words sorted by mastery level or date added
- Each entry: Korean word, English definition, mastery bar (0–100)
- Active words (mastery 0–99) and Mastered words (mastery 100) in separate sections
- Tap any word for full details and example sentence

---

## Word Bank Mechanics

### Production word bank model

In production the word bank is the full TOPIK I+II dictionary (~2,300 words), pre-seeded in Supabase. Every user starts with all TOPIK words at mastery 0; mastery is tracked per-user per-word. Users can also add custom words beyond TOPIK scope.

| | Prototype | Production |
|---|---|---|
| Word bank source | User-encountered words | TOPIK dictionary (pre-seeded) + user additions |
| Word bank size | ~100 words | ~2,300 TOPIK I+II words + custom words |
| Mastery tracking | per-word (0–100) | per-word per-user (0–100), starts at 0 |
| Custom words | ❌ | ✅ user can add any word |

**How mastery changes:**
- Tapping a highlighted word opens a quiz popup
- 4 multiple-choice English definitions (1 correct + 3 distractors)
- Correct answer: +1 mastery (floored at 100)
- Wrong answer: -1 mastery (floored at 0)

**Mastery levels:**
- Mastery is an integer 0–100
- At mastery 100: word graduates to "Mastered"
- Mastered words reappear as maintenance quizzes; a wrong answer drops mastery to 99

**Frontend color-coding** based on `topikLevel` vs user's current TOPIK level:
- `topikLevel <= userLevel` + high mastery → subtle gray underline (known)
- `topikLevel <= userLevel` + low mastery → blue underline (reinforce)
- `topikLevel > userLevel` → orange underline (challenge)

**Integration with articles:**
- Claude receives the user's TOPIK level and is instructed to tag every vocabulary word with its TOPIK level
- Words appear highlighted in Reading View based on the color-coding rules above

---

## Scoring

Each article has a permanent, one-time score:

- **Word quiz score**: sum of all +1/-1 from inline quiz answers during reading
- **Comprehension score**: sum of +1/-1 from the 3 end-of-article questions
- **Total score**: combined

Scores are locked when the article is archived. Re-reading is not allowed — one score per article, permanent. Scores are visible on archived article cards.

---

## Data Model

```sql
-- Auth (managed by NextAuth)
users (id, email, created_at)

-- User preferences
user_settings (user_id, topik_level)  -- topik_level: 1–6

-- Global TOPIK dictionary (pre-seeded once, ~2,300 words)
CREATE TABLE topik_words (
  id           SERIAL PRIMARY KEY,
  korean       TEXT NOT NULL,
  english      TEXT,
  romanization TEXT,
  topik_level  SMALLINT NOT NULL  -- 1–6
);

-- Per-user mastery (row created on first encounter or pre-seeded at 0)
CREATE TABLE user_word_mastery (
  id            SERIAL PRIMARY KEY,
  user_id       UUID REFERENCES auth.users,
  word_id       INT REFERENCES topik_words(id),
  mastery       SMALLINT DEFAULT 0,   -- 0–100
  times_correct INT DEFAULT 0,
  times_seen    INT DEFAULT 0,
  UNIQUE(user_id, word_id)
);

-- User-added custom words (non-TOPIK vocabulary)
CREATE TABLE user_custom_words (
  id           SERIAL PRIMARY KEY,
  user_id      UUID REFERENCES auth.users,
  korean       TEXT NOT NULL,
  english      TEXT,
  romanization TEXT,
  mastery      SMALLINT DEFAULT 0,
  added_at     TIMESTAMPTZ DEFAULT NOW()
);

-- Articles
CREATE TABLE articles (
  id                     UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id                UUID REFERENCES auth.users,
  source_url             TEXT,
  title                  TEXT,
  adapted_korean         JSONB,  -- array of Segment objects (see Segment type below)
  original_english       TEXT,
  topik_level_at_time    INT,
  status                 TEXT,   -- 'unread' | 'reading' | 'completed'
  word_quiz_score        INT DEFAULT 0,
  comprehension_score    INT DEFAULT 0,
  total_score            INT DEFAULT 0,
  comprehension_questions JSONB, -- [{id, question, options, correct, user_answer}]
  created_at             TIMESTAMPTZ DEFAULT NOW(),
  completed_at           TIMESTAMPTZ
);
```

### Segment type (production)

```ts
type Segment =
  | { type: 'text'; text: string }
  | { type: 'word'; text: string; wordId: number; topikLevel: 1|2|3|4|5|6; userMastery: number }
```

The `wordId` references `topik_words.id`. The `userMastery` field is denormalized at render time from `user_word_mastery` and is not stored in the article JSON.

---

## Key AI Prompt Design

Claude is called once per article via `/api/adapt` and returns a structured JSON object. The system prompt is cached with `cache_control: { type: 'ephemeral' }` to reduce cost on repeat calls.

**Input to Claude:**
- TOPIK level (1–6) in the user message
- Extracted article text in the user message
- Full TOPIK vocabulary reference (organized by level 1–6) in the cached system prompt

**Output from Claude:**
```json
{
  "adaptedKorean": [
    { "text": "...", "type": "text" },
    { "text": "경제적", "type": "word", "wordId": 42, "topikLevel": 2 }
  ],
  "comprehensionQuestions": [
    {
      "id": "q1",
      "question": "...",
      "options": ["...", "...", "...", "..."],
      "correct": 0
    }
  ]
}
```

**Morphology handling:** Claude uses its built-in Korean linguistic knowledge to correctly identify that inflected forms like `경제적` or `경제를` are forms of `경제` (TOPIK level 2). This avoids the need for a Korean NLP library on Vercel. Accuracy ~90–95%, acceptable for a personal learning tool.

**Token budget (per article after cache warm):**

| Component | Tokens | Cost |
|---|---|---|
| System prompt (cache read) | ~12,000 | ~$0.004 |
| User message | ~800 | ~$0.002 |
| Output | ~1,200 | ~$0.018 |
| **Total** | | **~$0.024** |

---

## PWA / Share Target

`manifest.json` declares a share target:

```json
{
  "share_target": {
    "action": "/share",
    "method": "GET",
    "params": { "url": "url" }
  }
}
```

The `/share` route receives the URL, starts processing, and redirects to the Article Processing screen.

---

## Out of Scope (v1)

- Push notifications
- Social features / sharing scores
- Audio / pronunciation
- Handwriting practice
- Android share sheet (same PWA mechanism, lower priority)
